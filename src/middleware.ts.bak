import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

/**
 * Next.js Middleware for Custom Domain Routing
 *
 * This middleware intercepts all requests and:
 * 1. Detects the incoming domain
 * 2. Routes custom domains to their respective shop pages
 * 3. Routes shop.ezymemo.com to marketplace pages
 * 4. Allows normal ezymemo.com traffic to pass through
 */

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080';
const MARKETPLACE_DOMAIN = process.env.NEXT_PUBLIC_MARKETPLACE_DOMAIN || 'shop.ezymemo.com';
const MAIN_DOMAIN = process.env.NEXT_PUBLIC_MAIN_DOMAIN || 'ezymemo.com';

export async function middleware(request: NextRequest) {
  const { hostname, pathname } = request.nextUrl;

  // Skip middleware for static files, API routes, and Next.js internals
  if (
    pathname.startsWith('/_next') ||
    pathname.startsWith('/api') ||
    pathname.startsWith('/static') ||
    pathname.includes('.') // Files with extensions (images, fonts, etc.)
  ) {
    return NextResponse.next();
  }

  // Development mode: Allow direct access to /marketplace without subdomain
  const isLocalhost = hostname === 'localhost' ||
                      hostname.startsWith('localhost:') ||
                      hostname === '127.0.0.1' ||
                      hostname.startsWith('127.0.0.1:');

  if (isLocalhost) {
    // In development, /marketplace routes work directly without subdomain
    return NextResponse.next();
  }

  // Case 1: Marketplace domain (shop.ezymemo.com in production)
  if (hostname === MARKETPLACE_DOMAIN || hostname === `shop.${MAIN_DOMAIN}`) {
    // Rewrite to marketplace route group
    if (!pathname.startsWith('/marketplace')) {
      const url = request.nextUrl.clone();
      url.pathname = `/marketplace${pathname}`;
      return NextResponse.rewrite(url);
    }
    return NextResponse.next();
  }

  // Case 2: Main platform domain (ezymemo.com)
  if (hostname === MAIN_DOMAIN || hostname === `www.${MAIN_DOMAIN}`) {
    return NextResponse.next();
  }

  // Case 3: Custom domain - resolve to shop
  try {
    // Query backend to resolve custom domain
    const resolveUrl = `${API_BASE_URL}/api/domains/resolve?domain=${hostname}`;

    const response = await fetch(resolveUrl, {
      headers: {
        'Content-Type': 'application/json',
      },
      // Don't wait too long for domain resolution
      signal: AbortSignal.timeout(3000),
    });

    if (response.ok) {
      const data = await response.json();

      if (data.success && data.data?.shopSlug) {
        const { shopSlug } = data.data;

        // Rewrite to the shop page
        const url = request.nextUrl.clone();

        // If already on /shop/[slug], just continue
        if (pathname.startsWith(`/shop/${shopSlug}`)) {
          return NextResponse.next();
        }

        // Rewrite root domain requests to shop page
        // mystore.com/ -> ezymemo.com/shop/mystore
        // mystore.com/products -> ezymemo.com/shop/mystore/products
        url.pathname = `/shop/${shopSlug}${pathname}`;

        return NextResponse.rewrite(url);
      }
    }

    // Domain not found or not active - show 404
    return new NextResponse(
      `
      <!DOCTYPE html>
      <html>
        <head>
          <title>Domain Not Found</title>
          <style>
            body {
              font-family: system-ui, -apple-system, sans-serif;
              display: flex;
              align-items: center;
              justify-content: center;
              height: 100vh;
              margin: 0;
              background: #f5f5f5;
            }
            .container {
              text-align: center;
              padding: 2rem;
              background: white;
              border-radius: 8px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            h1 { margin: 0 0 1rem; color: #333; }
            p { color: #666; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>Domain Not Configured</h1>
            <p>This domain is not currently active or configured.</p>
            <p>Please contact the shop owner for assistance.</p>
          </div>
        </body>
      </html>
      `,
      {
        status: 404,
        headers: { 'Content-Type': 'text/html' },
      }
    );
  } catch (error) {
    console.error('Domain resolution error:', error);

    // On error, return 503 Service Unavailable
    return new NextResponse(
      `
      <!DOCTYPE html>
      <html>
        <head>
          <title>Service Unavailable</title>
          <style>
            body {
              font-family: system-ui, -apple-system, sans-serif;
              display: flex;
              align-items: center;
              justify-content: center;
              height: 100vh;
              margin: 0;
              background: #f5f5f5;
            }
            .container {
              text-align: center;
              padding: 2rem;
              background: white;
              border-radius: 8px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            h1 { margin: 0 0 1rem; color: #333; }
            p { color: #666; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>Service Temporarily Unavailable</h1>
            <p>We're experiencing technical difficulties.</p>
            <p>Please try again in a few moments.</p>
          </div>
        </body>
      </html>
      `,
      {
        status: 503,
        headers: { 'Content-Type': 'text/html' },
      }
    );
  }
}

// Configure which paths the middleware should run on
export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public folder files
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp|ico|woff|woff2|ttf|eot)$).*)',
  ],
};
